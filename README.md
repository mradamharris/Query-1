# Query-1

DECLARE @STARTDATE DATE = '2024-01-01';
DECLARE @ENDDATE DATE = '2024-12-31';

/****************CHARGE****************/
DROP TABLE IF EXISTS #TEMPCHARGE;

SELECT 
    'DB1' AS DATA_SOURCE,
    c.PATIENT_ID,
    c.DOS,
    c.INSURANCE_ID,
    SUM(c.CHARGE) AS CHARGE,
    c.CHARGE_ID,
    c.LOCATION_ID,
    c.DOCTOR_ID,
    d.DOCTOR_NAME,
    p.PATIENT_NAME
INTO #TEMPCHARGE
FROM DB1.DBO.CHARGE c
LEFT JOIN DB1.DBO.INSURANCE i 
    ON c.DATA_SOURCE = i.DATA_SOURCE 
   AND c.INSURANCE_ID = i.INSURANCE_ID
LEFT JOIN DB1.DBO.DOCTOR d 
    ON c.DOCTOR_ID = d.DOCTOR_ID
LEFT JOIN DB1.DBO.PATIENT p 
    ON c.PATIENT_ID = p.PATIENT_ID
WHERE c.DOS BETWEEN @STARTDATE AND @ENDDATE
GROUP BY 
    c.PATIENT_ID, c.DOS, c.INSURANCE_ID, 
    c.CHARGE_ID, c.LOCATION_ID, 
    c.DOCTOR_ID, d.DOCTOR_NAME, p.PATIENT_NAME;

/****************PAYMENT****************/
DROP TABLE IF EXISTS #TEMPPAYMENT;

SELECT 
    'DB1' AS DATA_SOURCE,
    c.PATIENT_ID,
    c.DOS,
    c.INSURANCE_ID,
    SUM(c.PAYMENT) AS PAYMENT,
    c.CHARGE_ID,
    c.PAYMENT_ID,
    c.SYSTEM_DATE,
    c.POST_DATE,
    c.CHARGE_LINE_COUNT,
    i.INSURANCE_NAME
INTO #TEMPPAYMENT
FROM DB1.DBO.PAYMENT c
LEFT JOIN DB1.DBO.INSURANCE i 
    ON c.DATA_SOURCE = i.DATA_SOURCE 
   AND c.INSURANCE_ID = i.INSURANCE_ID
WHERE c.DOS BETWEEN @STARTDATE AND @ENDDATE
GROUP BY 
    c.PATIENT_ID, c.DOS, c.INSURANCE_ID,
    c.CHARGE_ID, c.PAYMENT_ID,
    c.SYSTEM_DATE, c.POST_DATE,
    c.CHARGE_LINE_COUNT, i.INSURANCE_NAME;

/****************REFUND****************/
DROP TABLE IF EXISTS #TEMPREFUND;

SELECT 
    'DB1' AS DATA_SOURCE,
    c.PATIENT_ID,
    c.DOS,
    c.INSURANCE_ID,
    SUM(c.REFUND) AS REFUND,
    c.CHARGE_ID,
    c.PAYMENT_ID
INTO #TEMPREFUND
FROM DB1.DBO.REFUND c
LEFT JOIN DB1.DBO.INSURANCE i 
    ON c.DATA_SOURCE = i.DATA_SOURCE 
   AND c.INSURANCE_ID = i.INSURANCE_ID
WHERE c.DOS BETWEEN @STARTDATE AND @ENDDATE
GROUP BY 
    c.PATIENT_ID, c.DOS, c.INSURANCE_ID,
    c.CHARGE_ID, c.PAYMENT_ID;

/****************TRANSACTION****************/
DROP TABLE IF EXISTS #TEMPTRANSACTION;

SELECT 
    'DB1' AS DATA_SOURCE,
    f.PATIENT_ID,
    f.PATIENT_NAME,
    f.CHARGE_ID,
    f.VISIT_NUMBER,
    f.LOCATION_ID,
    f.ACCESSION,
    f.DOCTOR_ID,
    f.DOCTOR_NAME,
    f.DOS,
    f.SYSTEM_DATE,
    f.POST_DATE,
    COALESCE(fh.FILED_DATE, f.INITIAL_STATEMENT_DATE) AS INITIAL_BILL_DATE,
    f.CPT,
    f.MODIFIER,
    f.ICD10,
    f.CHARGE_COUNT,
    f.INSURANCE_TYPE,
    f.PRIMARY_INSURANCE_NAME,
    f.INSURANCE_NAME,
    f.CHARGE_STATUS,
    SUM(f.ADJUSTMENT) AS ADJUSTMENT,
    SUM(f.BALANCE) AS BALANCE,
    f.PAYMENT_ID,
    f.PRIMARY_INSURANCE_ID
INTO #TEMPTRANSACTION
FROM DB1.DBO.[TRANSACTION] f
LEFT JOIN FILING fh 
    ON f.CHARGE_ID = fh.CHARGE_ID
WHERE f.DOS BETWEEN @STARTDATE AND @ENDDATE
GROUP BY
    f.PATIENT_ID, f.PATIENT_NAME, f.CHARGE_ID,
    f.VISIT_NUMBER, f.LOCATION_ID, f.ACCESSION,
    f.DOCTOR_ID, f.DOCTOR_NAME, f.DOS,
    f.SYSTEM_DATE, f.POST_DATE,
    fh.FILED_DATE, f.INITIAL_STATEMENT_DATE,
    f.CPT, f.MODIFIER, f.ICD10,
    f.CHARGE_COUNT, f.INSURANCE_TYPE,
    f.PRIMARY_INSURANCE_NAME, f.INSURANCE_NAME,
    f.CHARGE_STATUS, f.PAYMENT_ID, f.PRIMARY_INSURANCE_ID;

/****************JOINED****************/
SELECT 
    a.DATA_SOURCE,
    a.PATIENT_ID,
    a.PATIENT_NAME,
    a.VISIT_NUMBER,
    a.LOCATION_ID,
    a.ACCESSION,
    a.DOCTOR_ID,
    a.DOCTOR_NAME,
    a.DOS,
    a.SYSTEM_DATE,
    a.POST_DATE,
    a.INITIAL_BILL_DATE,
    a.CPT,
    a.MODIFIER,
    a.ICD10,
    a.CHARGE_COUNT,
    a.INSURANCE_TYPE,
    a.PRIMARY_INSURANCE_NAME,
    a.INSURANCE_NAME,
    a.CHARGE_STATUS,
    CASE WHEN a.ROWNUMBER = 1 THEN a.CHARGE ELSE 0 END AS CHARGE,
    a.PAYMENT,
    a.ADJUSTMENT,
    a.REFUND,
    a.BALANCE,
    a.PAYMENT_ID,
    a.PRIMARY_INSURANCE_ID
FROM (
    SELECT
        c.DATA_SOURCE,
        c.PATIENT_ID,
        c.PATIENT_NAME,
        t.VISIT_NUMBER,
        c.LOCATION_ID,
        t.ACCESSION,
        c.DOCTOR_ID,
        c.DOCTOR_NAME,
        c.DOS,
        p.SYSTEM_DATE,
        p.POST_DATE,
        t.INITIAL_BILL_DATE,
        t.CPT,
        t.MODIFIER,
        t.ICD10,
        p.CHARGE_LINE_COUNT AS CHARGE_COUNT,
        t.INSURANCE_TYPE,
        t.PRIMARY_INSURANCE_NAME,
        p.INSURANCE_NAME,
        t.CHARGE_STATUS,
        ROW_NUMBER() OVER (PARTITION BY c.CHARGE_ID ORDER BY c.CHARGE_ID) AS ROWNUMBER,
        p.PAYMENT,
        t.ADJUSTMENT,
        r.REFUND,
        t.BALANCE,
        p.PAYMENT_ID,
        t.PRIMARY_INSURANCE_ID,
        c.CHARGE
    FROM #TEMPCHARGE c
    LEFT JOIN #TEMPPAYMENT p 
        ON c.PATIENT_ID = p.PATIENT_ID
       AND c.DOS = p.DOS
       AND c.CHARGE_ID = p.CHARGE_ID
    LEFT JOIN #TEMPREFUND r 
        ON p.PATIENT_ID = r.PATIENT_ID
       AND p.DOS = r.DOS
       AND p.CHARGE_ID = r.CHARGE_ID
       AND p.PAYMENT_ID = r.PAYMENT_ID
       AND p.INSURANCE_ID = r.INSURANCE_ID
    LEFT JOIN #TEMPTRANSACTION t 
        ON c.DOS = t.DOS
       AND c.PATIENT_ID = t.PATIENT_ID
       AND p.PAYMENT_ID = t.PAYMENT_ID
) a
ORDER BY a.DOS, a.PATIENT_ID;
